<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriConnect Crop Insurance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f1f8e9;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .navbar {
            background-color: #4caf50;
        }

        .navbar-brand,
        .nav-link {
            color: white !important;
        }

        .main-content {
            flex: 1;
            padding-top: 60px;
        }

        .container {
            max-width: 1000px;
            margin-top: 30px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: #4caf50;
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .btn-success {
            background-color: #4caf50;
            border: none;
        }

        .btn-success:hover {
            background-color: #45a049;
        }

        footer {
            background-color: #4caf50;
            color: white;
            padding: 20px 0;
            margin-top: 30px;
        }

        .footer-heading {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .footer-content {
            font-size: 0.9em;
        }

        .social-icons {
            font-size: 1.5em;
        }

        .social-icons a {
            color: white;
            margin-right: 10px;
        }

        #insuranceDocument {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">AgriConnect</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="market.html">Market Access</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="insurance.html">Crop Insurance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resource.html">Resources</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contact Us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="manage.html">Account</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <h1 class="text-center mb-4">Crop Insurance Application</h1>
            <div id="greeting" class="text-center mb-3"></div>
            <div id="datetime" class="text-center mb-4"></div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Insurance Application Form</h5>
                        </div>
                        <div class="card-body">
                            <form id="insuranceForm">
                                <div class="mb-3">
                                    <label for="farmerName" class="form-label">Farmer Name</label>
                                    <input type="text" class="form-control" id="farmerName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="cropType" class="form-label">Crop Type</label>
                                    <select class="form-select" id="cropType" required>
                                        <option value="">Select crop type</option>
                                        <option value="Maize">Maize</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Coffee">Coffee</option>
                                        <option value="Tea">Tea</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="acreage" class="form-label">Acreage</label>
                                    <input type="number" class="form-control" id="acreage" required>
                                </div>
                                <div class="mb-3">
                                    <label for="insurancePackage" class="form-label">Insurance Package</label>
                                    <select class="form-select" id="insurancePackage" required>
                                        <option value="">Select package</option>
                                        <option value="Basic">Basic</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Premium">Premium</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="premiumType" class="form-label">Premium Type</label>
                                    <select class="form-select" id="premiumType" required>
                                        <option value="">Select premium type</option>
                                        <option value="Annual">Annual</option>
                                        <option value="Semi-Annual">Semi-Annual</option>
                                        <option value="Quarterly">Quarterly</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success">Apply for Insurance</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Insurance Details</h5>
                        </div>
                        <div class="card-body">
                            <div id="insuranceDetails"></div>
                            <div id="paymentSection" style="display: none;">
                                <h4 class="mt-4">M-Pesa Payment</h4>
                                <form id="mpesa-payment-form">
                                    <div class="mb-3">
                                        <label for="phone-number" class="form-label">M-Pesa Phone Number</label>
                                        <input type="tel" class="form-control" id="phone-number"
                                            placeholder="254XXXXXXXXX" required>
                                    </div>
                                    <button id="submit-payment" class="btn btn-success">Pay with M-Pesa</button>
                                </form>
                                <div id="payment-status" class="mt-3"></div>
                            </div>
                            <div id="insuranceDocument" class="mt-4">
                                <h4>Insurance Document</h4>
                                <div id="documentContent" class="border p-3"></div>
                                <button id="printButton" class="btn btn-primary mt-3">Print Insurance</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="footer-heading">About AgriConnect</h5>
                    <p class="footer-content">Empowering farmers with technology, market access, and financial security
                        since 2024.</p>
                </div>
                <div class="col-md-4">
                    <h5 class="footer-heading">Quick Links</h5>
                    <ul class="list-unstyled footer-content">
                        <li><a href="#" class="text-white">FAQs</a></li>
                        <li><a href="#" class="text-white">Terms of Service</a></li>
                        <li><a href="#" class="text-white">Privacy Policy</a></li>
                        <li><a href="contact.html" class="text-white">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="footer-heading">Connect With Us</h5>
                    <p class="footer-content">Stay updated with our latest news and offers:</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </div>
            <hr class="mt-4 mb-4" style="background-color: white;">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p class="footer-content">&copy; 2024 AgriConnect. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to get greeting based on time of day
        function getGreeting() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userName = currentUser.name || 'Farmer';
            const hour = new Date().getHours();
            if (hour < 12) return `Good morning, ${userName}!`;
            if (hour < 18) return `Good afternoon, ${userName}!`;
            return `Good evening, ${userName}!`;
        }

        // Function to update date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('datetime').textContent = now.toLocaleString();
        }

        // Set initial greeting and start updating date/time
        document.getElementById('greeting').textContent = getGreeting();
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Insurance application form submission
        document.getElementById('insuranceForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const farmerName = document.getElementById('farmerName').value;
            const cropType = document.getElementById('cropType').value;
            const acreage = document.getElementById('acreage').value;
            const insurancePackage = document.getElementById('insurancePackage').value;
            const premiumType = document.getElementById('premiumType').value;

            // Calculate premium (this is a simple example, real calculations would be more complex)
            let basePremium = 0;
            switch (insurancePackage) {
                case 'Basic': basePremium = 1000; break;
                case 'Standard': basePremium = 2000; break;
                case 'Premium': basePremium = 3000; break;
            }
            const totalPremium = basePremium * parseInt(acreage);

            const insuranceData = {
                policyNumber: 'CIP-' + Math.floor(Math.random() * 1000000),
                farmerName: farmerName,
                cropType: cropType,
                acreage: acreage,
                insurancePackage: insurancePackage,
                premiumType: premiumType,
                totalPremium: totalPremium,
                startDate: new Date().toLocaleDateString(),
                endDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString(),
                transactionDate: new Date().toLocaleString(),
                status: 'Pending Payment'
            };

            let insurances = JSON.parse(localStorage.getItem('insurances')) || [];
            insurances.push(insuranceData);
            localStorage.setItem('insurances', JSON.stringify(insurances));

            const insuranceDetails = document.getElementById('insuranceDetails');
            insuranceDetails.innerHTML = `
                <h4>Insurance Application Summary</h4>
                <p><strong>Policy Number:</strong> ${insuranceData.policyNumber}</p>
                <p><strong>Farmer Name:</strong> ${insuranceData.farmerName}</p>
                <p><strong>Crop Type:</strong> ${insuranceData.cropType}</p>
                <p><strong>Acreage:</strong> ${insuranceData.acreage}</p>
                <p><strong>Insurance Package:</strong> ${insuranceData.insurancePackage}</p>
                <p><strong>Premium Type:</strong> ${insuranceData.premiumType}</p>
                <p><strong>Total Premium:</strong> KES ${insuranceData.totalPremium.toFixed(2)}</p>
                <p><strong>Start Date:</strong> ${insuranceData.startDate}</p>
                <p><strong>End Date:</strong> ${insuranceData.endDate}</p>
                <p><strong>Status:</strong> ${insuranceData.status}</p>
            `;

            document.getElementById('paymentSection').style.display = 'block';
            document.getElementById('submit-payment').textContent = `Pay KES ${insuranceData.totalPremium.toFixed(2)} with M-Pesa`;
        });

        // M-Pesa payment integration
        // M-Pesa payment integration
        document.getElementById('mpesa-payment-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const phoneNumber = document.getElementById('phone-number').value;
            const paymentStatus = document.getElementById('payment-status');

            // Get the last insurance entry
            let insurances = JSON.parse(localStorage.getItem('insurances')) || [];
            let lastInsurance = insurances[insurances.length - 1];

            // Simulate M-Pesa API call
            paymentStatus.textContent = "Processing payment...";

            // M-Pesa API Authentication
            let headers = new Headers();
            headers.append("Authorization", "Basic T1pzRHZqNUtWR25RTFVFS1J1ekNCMkJLMmN4NTJJMG9sVUdYU2Y3QmRBckhhVkFMOjdLcFc4cEh4dWkzV25YRkZ0ZzZ3VTVvWUpWSWIxZnloSXhmOUd4bmV4UkNwZXVaQjFXYXA4aUtzWEZpR09JMlM=");

            fetch("https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials", { headers })
                .then(response => response.json())  // Changed from response.text() to response.json()
                .then(result => {
                    console.log(result);
                    // Here you would use the access token from the result to make further M-Pesa API calls
                    // For this example, we'll just simulate a successful payment after a delay
                    setTimeout(() => {
                        // Simulating a successful payment
                        paymentStatus.textContent = "Payment successful! Check your phone for M-Pesa confirmation.";

                        // Update the insurance status
                        lastInsurance.status = 'Active';
                        localStorage.setItem('insurances', JSON.stringify(insurances));

                        // Update the insurance details display
                        const insuranceDetails = document.getElementById('insuranceDetails');
                        insuranceDetails.innerHTML = insuranceDetails.innerHTML.replace('Pending Payment', 'Active');

                        // Hide payment section and show insurance document
                        document.getElementById('paymentSection').style.display = 'none';
                        generateInsuranceDocument(lastInsurance);
                    }, 3000); // Simulating a 3-second process
                })
                .catch(error => {
                    console.log(error);
                    paymentStatus.textContent = "Payment processing failed. Please try again.";
                });
        });

        function generateInsuranceDocument(insuranceData) {
            const documentContent = document.getElementById('documentContent');
            documentContent.innerHTML = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; border: 2px solid #4caf50; border-radius: 15px; background-color: #f1f8e9;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="color: #4caf50; margin: 10px 0;">AgriConnect</h1>
                    <p style="font-style: italic;">Empowering farmers with technology and financial security</p>
                </div>
                <h2 style="text-align: center; color: #45a049; border-bottom: 2px solid #45a049; padding-bottom: 10px;">Crop Insurance Policy</h2>
                <div style="background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <p style="font-size: 18px;"><strong>Policy Number:</strong> ${insuranceData.policyNumber}</p>
                    <p><strong>Farmer Name:</strong> ${insuranceData.farmerName}</p>
                    <p><strong>Crop Insured:</strong> ${insuranceData.cropType}</p>
                    <p><strong>Insured Acreage:</strong> ${insuranceData.acreage}</p>
                    <p><strong>Insurance Package:</strong> ${insuranceData.insurancePackage}</p>
                    <p><strong>Premium Type:</strong> ${insuranceData.premiumType}</p>
                    <p><strong>Total Premium:</strong> KES ${insuranceData.totalPremium.toFixed(2)}</p>
                    <p><strong>Policy Start Date:</strong> ${insuranceData.startDate}</p>
                    <p><strong>Policy End Date:</strong> ${insuranceData.endDate}</p>
                    <p><strong>Status:</strong> ${insuranceData.status}</p>
                </div>
                <div style="margin-top: 20px; padding: 15px; background-color: #e8f5e9; border-radius: 10px;">
                    <p style="font-style: italic; color: #2e7d32;">This document certifies that the above-mentioned farmer is insured under our Crop Insurance Program, subject to the terms and conditions of the policy.</p>
                </div>
                <div style="margin-top: 30px; text-align: center; font-size: 14px; color: #666;">
                    <p>AgriConnect Ltd.</p>
                    <p>123 Farmer's Avenue, Nairobi, Kenya</p>
                    <p>Phone: +254 123 456 789 | Email: support@agriconnect.com</p>
                </div>
            </div>
            `;
            document.getElementById('insuranceDocument').style.display = 'block';
        }

        // Print functionality
        document.getElementById('printButton').addEventListener('click', function () {
            const printContent = document.getElementById('documentContent').innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            location.reload(); // Reload the page after printing
        });
    </script>
</body>

</html>